name: 游 CI/CD Pipeline Orchestrator

on:
  workflow_dispatch:  # Manual trigger with a single click
    inputs:
      run_all:
        description: 'Run all component and system workflows'
        required: true
        default: true
        type: boolean

jobs:
  early-validation:
    name: 游댌 Early Requirements Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: 游닌 Checkout System Repository
        uses: actions/checkout@v4

      - name: 游댢 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: 游닍 Install dependencies
        run: |
          npm init -y
          npm install ajv ajv-formats
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: 游댢 Setup GitHub CLI
        run: |
          # Install GitHub CLI if not already available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh
          fi
          
          # Login to GitHub CLI using the workflow token
          echo "${{ secrets.CROSS_REPO_TOKEN }}" | gh auth login --with-token
      
      - name: 游닌 Fetch Component Requirements
        run: |
          # Create directories
          mkdir -p components/ios/requirements
          mkdir -p components/android/requirements
          mkdir -p components/ipfs/requirements
          
          # Fetch files using GitHub API
          echo "Fetching iOS requirements..."
          gh api repos/journalbrand/journaltrove-ios/contents/requirements/requirements.jsonld --jq '.content' | base64 -d > components/ios/requirements/requirements.jsonld
          
          echo "Fetching Android requirements..."
          gh api repos/journalbrand/journaltrove-android/contents/requirements/requirements.jsonld --jq '.content' | base64 -d > components/android/requirements/requirements.jsonld
          
          echo "Fetching IPFS requirements..."
          gh api repos/journalbrand/journaltrove-ipfs/contents/requirements/requirements.jsonld --jq '.content' | base64 -d > components/ipfs/requirements/requirements.jsonld
      
      - name: 游닌 Fetch Component Test Mappings
        run: |
          # Make script executable
          chmod +x scripts/fetch-test-mappings.sh
          
          # Run the script
          ./scripts/fetch-test-mappings.sh
      
      - name: 游댌 Validate JSON-LD Format
        run: |
          # Validate all requirements files
          echo "Validating system requirements..."
          jq empty requirements/requirements.jsonld
          
          echo "Validating iOS requirements..."
          jq empty components/ios/requirements/requirements.jsonld
          
          echo "Validating Android requirements..."
          jq empty components/android/requirements/requirements.jsonld
          
          echo "Validating IPFS requirements..."
          jq empty components/ipfs/requirements/requirements.jsonld
      
      - name: 游빍 Validate Requirements Hierarchy
        run: |
          # Make validation script executable
          chmod +x scripts/validate-requirements-early.js
          
          # Run validation on all requirements files
          echo "Validating requirements hierarchy and test mappings..."
          node scripts/validate-requirements-early.js \
            requirements/requirements.jsonld \
            components/ios/requirements/requirements.jsonld \
            components/android/requirements/requirements.jsonld \
            components/ipfs/requirements/requirements.jsonld \
            tmp/test-mappings/ios/test-mappings.jsonld \
            tmp/test-mappings/android/test-mappings.jsonld \
            tmp/test-mappings/ipfs/test-mappings.jsonld

  trigger-component-workflows:
    name: 游댃 Trigger Component Workflows
    runs-on: ubuntu-latest
    needs: [early-validation]
    
    steps:
      - name: 游닌 Checkout System Repository
        uses: actions/checkout@v4

      - name: 游닇 Log Orchestration Start
        run: echo "Starting CI/CD pipeline orchestration across all repositories"
        
      - name: 游댢 Setup GitHub CLI
        run: |
          # Install GitHub CLI if not already available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh
          fi
          
          # Login to GitHub CLI using the workflow token
          echo "${{ secrets.CROSS_REPO_TOKEN }}" | gh auth login --with-token
      
      - name: 游 Trigger iOS CI Workflow
        run: |
          echo "Triggering iOS CI workflow..."
          gh workflow run ci.yml --repo journalbrand/journaltrove-ios
          
          # Wait for workflow to start running
          sleep 5
          
          # Get the ID of the most recent workflow run
          RUN_ID=$(gh run list --repo journalbrand/journaltrove-ios --workflow=ci.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          
          echo "iOS CI workflow triggered, run ID: $RUN_ID"
          echo "Waiting for iOS CI workflow to complete..."
          
          # Poll until the workflow completes
          while true; do
            STATUS=$(gh run view $RUN_ID --repo journalbrand/journaltrove-ios --json status --jq '.status')
            if [[ "$STATUS" == "completed" ]]; then
              CONCLUSION=$(gh run view $RUN_ID --repo journalbrand/journaltrove-ios --json conclusion --jq '.conclusion')
              echo "iOS CI workflow completed with status: $CONCLUSION"
              if [[ "$CONCLUSION" != "success" ]]; then
                echo "::error::iOS CI workflow failed!"
                exit 1
              fi
              break
            fi
            echo "iOS CI workflow is still running..."
            sleep 30
          done
      
      - name: 游 Trigger Android CI Workflow
        run: |
          echo "Triggering Android CI workflow..."
          gh workflow run ci.yml --repo journalbrand/journaltrove-android
          
          # Wait for workflow to start running
          sleep 5
          
          # Get the ID of the most recent workflow run
          RUN_ID=$(gh run list --repo journalbrand/journaltrove-android --workflow=ci.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          
          echo "Android CI workflow triggered, run ID: $RUN_ID"
          echo "Waiting for Android CI workflow to complete..."
          
          # Poll until the workflow completes
          while true; do
            STATUS=$(gh run view $RUN_ID --repo journalbrand/journaltrove-android --json status --jq '.status')
            if [[ "$STATUS" == "completed" ]]; then
              CONCLUSION=$(gh run view $RUN_ID --repo journalbrand/journaltrove-android --json conclusion --jq '.conclusion')
              echo "Android CI workflow completed with status: $CONCLUSION"
              if [[ "$CONCLUSION" != "success" ]]; then
                echo "::error::Android CI workflow failed!"
                exit 1
              fi
              break
            fi
            echo "Android CI workflow is still running..."
            sleep 30
          done
      
      - name: 游 Trigger IPFS CI Workflow
        run: |
          echo "Triggering IPFS CI workflow..."
          gh workflow run ci.yml --repo journalbrand/journaltrove-ipfs
          
          # Wait for workflow to start running
          sleep 5
          
          # Get the ID of the most recent workflow run
          RUN_ID=$(gh run list --repo journalbrand/journaltrove-ipfs --workflow=ci.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          
          echo "IPFS CI workflow triggered, run ID: $RUN_ID"
          echo "Waiting for IPFS CI workflow to complete..."
          
          # Poll until the workflow completes
          while true; do
            STATUS=$(gh run view $RUN_ID --repo journalbrand/journaltrove-ipfs --json status --jq '.status')
            if [[ "$STATUS" == "completed" ]]; then
              CONCLUSION=$(gh run view $RUN_ID --repo journalbrand/journaltrove-ipfs --json conclusion --jq '.conclusion')
              echo "IPFS CI workflow completed with status: $CONCLUSION"
              if [[ "$CONCLUSION" != "success" ]]; then
                echo "::error::IPFS CI workflow failed!"
                exit 1
              fi
              break
            fi
            echo "IPFS CI workflow is still running..."
            sleep 30
          done

  trigger-system-workflows:
    name: 游댃 Trigger System Workflows
    runs-on: ubuntu-latest
    needs: [trigger-component-workflows]
    
    steps:
      - name: 游닌 Checkout System Repository
        uses: actions/checkout@v4
        
      - name: 游댢 Setup GitHub CLI
        run: |
          # Install GitHub CLI if not already available
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh
          fi
          
          # Login to GitHub CLI using the workflow token
          echo "${{ secrets.CROSS_REPO_TOKEN }}" | gh auth login --with-token
      
      - name: 游 Trigger Compliance Matrix Generation Workflow
        run: |
          echo "Triggering Compliance Matrix Generation workflow..."
          gh workflow run compliance-matrix.yml --repo journalbrand/journaltrove-system
          
          # Wait for workflow to start running
          sleep 5
          
          # Get the ID of the most recent workflow run
          RUN_ID=$(gh run list --repo journalbrand/journaltrove-system --workflow=compliance-matrix.yml --limit=1 --json databaseId --jq '.[0].databaseId')
          
          echo "Compliance Matrix Generation workflow triggered, run ID: $RUN_ID"
          echo "Waiting for Compliance Matrix Generation workflow to complete..."
          
          # Poll until the workflow completes
          while true; do
            STATUS=$(gh run view $RUN_ID --repo journalbrand/journaltrove-system --json status --jq '.status')
            if [[ "$STATUS" == "completed" ]]; then
              CONCLUSION=$(gh run view $RUN_ID --repo journalbrand/journaltrove-system --json conclusion --jq '.conclusion')
              echo "Compliance Matrix Generation workflow completed with status: $CONCLUSION"
              if [[ "$CONCLUSION" != "success" ]]; then
                echo "::error::Compliance Matrix Generation workflow failed!"
                exit 1
              fi
              break
            fi
            echo "Compliance Matrix Generation workflow is still running..."
            sleep 30
          done
          
      - name: 游닇 Log CI/CD Pipeline Completion
        run: |
          echo "游꿀 CI/CD pipeline completed successfully across all repositories!"
          echo "The pipeline performed the following:"
          echo "- Ran iOS CI workflow (tests, generated results)"
          echo "- Ran Android CI workflow (tests, generated results)"
          echo "- Ran IPFS CI workflow (tests, generated results)"
          echo "- Generated compliance matrix from test results"
          echo "- Validated test results against requirements"
          echo "- Updated the compliance dashboard" 