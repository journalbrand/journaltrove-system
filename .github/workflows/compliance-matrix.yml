name: 🌹 Compliance Matrix Generation

on:
  workflow_dispatch:  # Manual trigger
  workflow_run:
    workflows: ["🍏 iOS CI", "🤖 Android CI", "Go CI"]
    types:
      - completed

jobs:
  validate-requirements:
    name: 📊 Validate Requirements
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout System Repository
        uses: actions/checkout@v4
      
      - name: 🔧 Setup jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      - name: 📦 Install ajv-cli for JSON Schema validation
        run: npm install -g ajv-cli
        
      - name: 🔍 Validate JSON-LD Requirements Format
        run: |
          if [ -f "requirements/requirements.jsonld" ]; then
            # Validate JSON-LD format
            jq empty requirements/requirements.jsonld
            echo "System requirements validation successful"
          else
            echo "Error: system requirements.jsonld not found"
            exit 1
          fi
          
          if [ -f "requirements/context/requirements-context.jsonld" ]; then
            # Validate context schema
            jq empty requirements/context/requirements-context.jsonld
            echo "Requirements context validation successful"
          else
            echo "Error: requirements-context.jsonld not found"
            exit 1
          fi
      
      - name: 🌟 Validate Against JSON Schema
        run: |
          if [ -f "schema/requirements-schema.json" ]; then
            ajv validate -s schema/requirements-schema.json -d requirements/requirements.jsonld
            echo "Schema validation successful"
          else
            echo "Warning: requirements-schema.json not found, skipping schema validation"
          fi
  
  aggregate-compliance:
    name: 🔄 Aggregate Compliance Matrix
    runs-on: ubuntu-latest
    needs: [validate-requirements]
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        
      - name: 🔧 Setup jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: 📂 Create Compliance Directories
        run: |
          mkdir -p compliance/results
          mkdir -p compliance/reports
        
      - name: 📥 Download iOS Test Results
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: ios-test-results-jsonld
          path: compliance/results/ios
          repo: example/todo-ios
          check_artifacts: true
          if_no_artifact_found: warn
          
      - name: 📥 Download Android Test Results
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: android-test-results-jsonld
          path: compliance/results/android
          repo: example/todo-android
          check_artifacts: true
          if_no_artifact_found: warn
          
      - name: 📥 Download IPFS Test Results
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: ipfs-test-results-jsonld
          path: compliance/results/ipfs
          repo: example/todo-ipfs
          check_artifacts: true
          if_no_artifact_found: warn
      
      - name: 🔄 Aggregate Compliance Matrix
        run: |
          # Ensure script is executable
          chmod +x compliance/scripts/aggregate_jsonld_compliance.sh
          # Run the aggregation script
          ./compliance/scripts/aggregate_jsonld_compliance.sh compliance/results compliance/reports/compliance_matrix.jsonld
        
      - name: 📤 Upload Compliance Matrix
        uses: actions/upload-artifact@v4
        with:
          name: compliance-matrix-jsonld
          path: compliance/reports/compliance_matrix.jsonld
          if-no-files-found: warn
          
      - name: 📊 Update Compliance Dashboard
        run: |
          # Ensure dashboard directory exists
          mkdir -p compliance/dashboard
          
          # Copy the compliance matrix to the dashboard directory
          cp compliance/reports/compliance_matrix.jsonld compliance/dashboard/compliance_matrix.jsonld
          
          echo "Compliance dashboard updated" 